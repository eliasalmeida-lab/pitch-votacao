<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gr√£o Direto ‚Äì Vota√ß√£o em Tempo Real</title>

  <!-- MUITO IMPORTANTE PARA MOBILE -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #16a34a;
      --primary-soft: #e0fce5;
      --accent: #8d6e63;
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --border: #e5e7eb;
      --text: #111827;
      --muted: #6b7280;
      --radius: 18px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Nunito", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background:
        radial-gradient(circle at top left, #dcfce7 0, transparent 45%),
        radial-gradient(circle at top right, #e0f2fe 0, transparent 45%),
        linear-gradient(to bottom, #f9fafb, #e5e7eb);
      color: var(--text);
      line-height: 1.5;
    }

    .container {
      width: 100%;
      max-width: 1320px;
      padding: 24px 12px 40px;
    }

    @media (min-width: 900px) {
      .container {
        padding: 40px 16px 56px;
      }
    }

    .logo-area {
      text-align: center;
      margin-bottom: 24px;
    }

    .logo {
      font-family: "Montserrat", system-ui;
      font-weight: 700;
      font-size: 26px;
      letter-spacing: 0.12em;
      margin-bottom: 6px;
      color: #111827;
      text-transform: uppercase;
    }

    .tagline {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 14px;
      border-radius: 999px;
      background: rgba(22, 163, 74, 0.06);
      color: #166534;
      font-size: 12px;
      font-weight: 500;
      border: 1px solid rgba(22, 163, 74, 0.2);
      gap: 6px;
      backdrop-filter: blur(6px);
    }

    .tag-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.4);
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      border: 1px solid rgba(148, 163, 184, 0.25);
      padding: 20px 20px;
      box-shadow:
        0 18px 45px rgba(15, 23, 42, 0.10),
        0 0 0 1px rgba(255, 255, 255, 0.9) inset;
      margin-bottom: 18px;
    }

    @media (min-width: 900px) {
      .card {
        padding: 22px 26px;
        margin-bottom: 22px;
      }
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
      gap: 12px;
    }

    .card-title {
      font-family: "Montserrat", system-ui;
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      letter-spacing: 0.02em;
    }

    .card-subtitle {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 10px;
      max-width: 640px;
    }

    .badge {
      padding: 5px 12px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: #f1f5f9;
      color: #111827;
      white-space: nowrap;
    }

    .badge-participant {
      background: #ecfdf5;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .badge-admin {
      background: #eff6ff;
      color: #1d4ed8;
      border: 1px solid #bfdbfe;
    }

    .input-group {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .input-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
    }

    .input {
      flex: 1;
      min-width: 130px;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid var(--border);
      outline: none;
      font-size: 14px;
      background: #f9fafb;
    }

    .input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.35);
      background: #ffffff;
    }

    .btn {
      padding: 9px 18px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition:
        transform 0.07s ease,
        box-shadow 0.12s ease,
        background 0.12s ease,
        border-color 0.12s ease;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--primary);
      color: #ffffff;
      box-shadow: 0 10px 24px rgba(22, 163, 74, 0.45);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 32px rgba(22, 163, 74, 0.55);
    }

    .btn-secondary {
      background: #f9fafb;
      color: #111827;
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: #f3f4f6;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }

    .btn-pill {
      border-radius: 999px;
      padding: 7px 13px;
    }

    .btn-outline {
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid #d1d5db;
      color: #374151;
    }

    .btn-outline.active {
      background: var(--primary-soft);
      border-color: var(--primary);
      color: #065f46;
      font-weight: 600;
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.4);
    }

    .status {
      font-size: 13px;
      margin-top: 8px;
    }

    .status-error {
      color: #b91c1c;
    }

    .status-success {
      color: #166534;
    }

    /* layout em uma coluna, centralizado */
    .layout {
      width: 100%;
      max-width: 1100px;
      margin: 16px auto 0;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .pill-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .question-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 8px;
    }

    .topic-block {
      border-radius: 14px;
      border: 1px solid #e2e8f0;
      padding: 12px 14px;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #f9fafb, #ffffff);
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.06);
    }

    .topic-text {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .topic-instruction {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .votes-row {
      display: flex;
      gap: 8px;
      margin-top: 2px;
      flex-wrap: wrap;
    }

    .vote-pill {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      cursor: pointer;
      background: #ffffff;
      transition:
        background 0.1s ease,
        border-color 0.1s ease,
        transform 0.06s ease,
        box-shadow 0.08s ease;
    }

    .vote-pill:hover:not(.disabled) {
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.16);
    }

    .vote-pill.selected {
      background: #bbf7d0;
      border-color: #16a34a;
      color: #14532d;
      font-weight: 600;
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.55);
    }

    .vote-pill.disabled {
      opacity: 0.4;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    /* Toast de notifica√ß√£o */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #111827;
      color: #fff;
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      z-index: 9999;
      opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    .toast.success {
      background: #16a34a;
    }
    .toast.error {
      background: #dc2626;
    }

    /* Barra de progresso */
    .progress-card {
      background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%);
      border: 1px solid #bbf7d0;
    }
    .progress-container {
      margin-top: 12px;
    }
    .progress-bar-wrapper {
      background: #e5e7eb;
      border-radius: 999px;
      height: 8px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #22c55e, #16a34a);
      border-radius: 999px;
      transition: width 0.5s ease;
    }
    .progress-stats {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }
    .progress-stat {
      text-align: center;
      flex: 1;
      min-width: 100px;
    }
    .progress-stat-value {
      font-size: 24px;
      font-weight: 700;
      color: #16a34a;
      font-family: "Montserrat", system-ui;
    }
    .progress-stat-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Anima√ß√£o de pulse no voto */
    @keyframes votePulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    .vote-pill.just-voted {
      animation: votePulse 0.3s ease;
    }

    /* Anima√ß√£o de check */
    @keyframes checkmark {
      0% { transform: scale(0) rotate(-45deg); opacity: 0; }
      50% { transform: scale(1.2) rotate(-45deg); opacity: 1; }
      100% { transform: scale(1) rotate(-45deg); opacity: 1; }
    }
    .vote-check {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 16px;
      height: 16px;
      background: #16a34a;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: white;
      animation: checkmark 0.3s ease forwards;
    }
    .vote-pill-wrapper {
      position: relative;
      display: inline-block;
    }

    /* Confetti canvas */
    #confetti-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9998;
    }

    /* Transi√ß√£o suave nos cards */
    .card {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 22px 50px rgba(15, 23, 42, 0.12), 0 0 0 1px rgba(255, 255, 255, 0.9) inset;
    }

    /* Badge de contagem */
    .count-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 20px;
      height: 20px;
      padding: 0 6px;
      border-radius: 999px;
      background: #16a34a;
      color: white;
      font-size: 11px;
      font-weight: 600;
      margin-left: 6px;
    }

    .section-title {
      font-family: "Montserrat", system-ui;
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .tabs {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      overflow: hidden;
      background: #f9fafb;
    }

    .tab {
      padding: 7px 16px;
      font-size: 13px;
      cursor: pointer;
      border: none;
      background: transparent;
      font-weight: 500;
      color: #4b5563;
    }

    .tab.active {
      background: #111827;
      color: #f9fafb;
    }

    .select {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 13px;
      outline: none;
      background: #f9fafb;
    }

    .select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.35);
      background: #ffffff;
    }

    textarea {
      width: 100%;
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 10px 12px;
      font-size: 13px;
      min-height: 90px;
      resize: vertical;
      background: #f9fafb;
    }

    textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.35);
      background: #ffffff;
    }

    .muted {
      color: var(--muted);
      font-size: 12px;
    }

    .ranking-list {
      max-height: 220px;
      overflow-y: auto;
      margin-top: 8px;
      border-radius: 14px;
      border: 1px solid #e2e8f0;
      background: #f9fafb;
      padding: 8px;
      font-size: 13px;
    }

    .ranking-item {
      padding: 7px 8px;
      border-radius: 10px;
      margin-bottom: 6px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
    }

    .ranking-title {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .ranking-meta {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .chip {
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
    }

    .small-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .votes-detail-list {
      max-height: 220px;
      overflow-y: auto;
      border-radius: 14px;
      border: 1px solid #e2e8f0;
      background: #f9fafb;
      padding: 8px;
      font-size: 12px;
    }

    .vote-detail-item {
      padding: 6px 7px;
      border-radius: 9px;
      margin-bottom: 5px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
    }

    .vote-detail-title {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .vote-detail-meta {
      color: var(--muted);
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .topic-admin-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 4px;
    }

    .topic-admin-row input {
      flex: 1;
      min-width: 0;
    }

    .btn-icon {
      padding: 4px 8px;
      font-size: 11px;
    }

    .btn-danger {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .btn-danger:hover {
      background: #fecaca;
    }

    /* ========= AJUSTES MOBILE ========= */
    @media (max-width: 768px) {
      body {
        align-items: flex-start;
      }

      .container {
        padding: 12px 8px 24px;
      }

      .logo {
        font-size: 22px;
      }

      .tagline {
        font-size: 12px;
        padding: 5px 10px;
      }

      .card {
        padding: 14px 12px;
        margin-bottom: 12px;
        border-radius: 14px;
      }

      .card:hover {
        transform: none; /* Desabilita hover em mobile */
        box-shadow: 0 18px 45px rgba(15, 23, 42, 0.10), 0 0 0 1px rgba(255, 255, 255, 0.9) inset;
      }

      .card-header {
        flex-direction: column;
        gap: 8px;
      }

      .card-title {
        font-size: 17px;
      }

      .card-subtitle {
        font-size: 13px;
      }

      .input,
      .select {
        font-size: 16px; /* evita zoom no iOS */
        padding: 12px 14px;
      }

      .input-group {
        flex-direction: column;
        align-items: stretch;
      }

      .input-group .input {
        width: 100%;
      }

      .btn {
        font-size: 15px;
        padding: 12px 16px;
        width: 100%;
      }

      .btn-small {
        font-size: 13px;
        padding: 10px 14px;
        width: auto;
      }

      .vote-pill {
        width: 44px;
        height: 44px;
        font-size: 16px;
      }

      .votes-row {
        gap: 6px;
        justify-content: flex-start;
      }

      .question-title {
        font-size: 15px;
        margin-bottom: 10px;
      }

      .topic-block {
        padding: 14px 12px;
        margin-bottom: 12px;
      }

      .topic-text {
        font-size: 14px;
        line-height: 1.4;
      }

      .topic-instruction {
        font-size: 12px;
        margin-bottom: 8px;
      }

      .layout {
        margin-top: 8px;
        max-width: 100%;
      }

      .pill-list {
        gap: 8px;
      }

      .pill-list .btn {
        width: auto;
        flex: 1;
        min-width: 45%;
      }

      /* Progresso mobile */
      .progress-stats {
        gap: 8px;
      }

      .progress-stat {
        min-width: 70px;
        flex: 1;
      }

      .progress-stat-value {
        font-size: 20px;
      }

      .progress-stat-label {
        font-size: 9px;
      }

      /* Toast mobile */
      .toast {
        left: 16px;
        right: 16px;
        transform: translateY(100px);
        width: auto;
        text-align: center;
        justify-content: center;
      }

      .toast.show {
        transform: translateY(0);
      }

      /* Tabs mobile */
      .tabs {
        width: 100%;
      }

      .tab {
        flex: 1;
        text-align: center;
        padding: 10px 8px;
        font-size: 12px;
      }

      /* Bot√µes de a√ß√£o mobile */
      #btn-next-presenter,
      #btn-load-stars {
        width: 100%;
        margin-top: 8px;
      }

      .section-title {
        font-size: 14px;
      }

      .muted {
        font-size: 11px;
      }

      .badge {
        font-size: 10px;
        padding: 4px 8px;
      }
    }

    /* Ajustes para telas muito pequenas */
    @media (max-width: 380px) {
      .container {
        padding: 8px 6px 20px;
      }

      .logo {
        font-size: 20px;
      }

      .vote-pill {
        width: 38px;
        height: 38px;
        font-size: 14px;
      }

      .progress-stat {
        min-width: 60px;
      }

      .progress-stat-value {
        font-size: 18px;
      }

      .progress-stat-label {
        font-size: 8px;
      }

      .pill-list .btn {
        min-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo-area">
      <div class="logo">GR√ÉO DIRETO</div>
      <div class="tagline">
        <span class="tag-dot"></span>
        Vota√ß√£o em tempo real
      </div>
    </div>

    <!-- Card de Login -->
    <div class="card" id="card-login">
      <div class="card-header">
        <div class="card-title">
          Acessar vota√ß√£o
        </div>
      </div>
      <div class="card-subtitle">
        Use o c√≥digo recebido para acessar como participante ou admin.
      </div>
      <div class="input-group">
        <label class="input-label" for="input-code">C√≥digo</label>
        <input id="input-code" class="input" placeholder="Digite seu c√≥digo" />
        <button class="btn btn-primary" id="btn-login">Entrar</button>
      </div>
      <div id="login-status" class="status"></div>
    </div>

    <!-- Layout principal (aparece depois do login) -->
    <div id="main-layout" style="display:none;">
      <!-- Cabe√ßalho geral -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title" id="welcome-title"></div>
            <div class="card-subtitle" id="welcome-subtitle"></div>
          </div>
          <div>
            <span id="role-badge" class="badge"></span>
          </div>
        </div>
      </div>

      <div class="layout">
        <!-- Bloco principal: participante + admin config -->
        <div>
          <!-- PARTICIPANTE -->
          <div id="participant-area" style="display:none;">
            <!-- Card de Progresso -->
            <div class="card progress-card" id="progress-card">
              <div class="card-header">
                <div class="card-title">üìä Seu progresso</div>
              </div>
              <div class="progress-container">
                <div class="progress-bar-wrapper">
                  <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
                </div>
                <div class="progress-stats">
                  <div class="progress-stat">
                    <div class="progress-stat-value" id="stat-apresentadores">0/0</div>
                    <div class="progress-stat-label">Apresentadores votados</div>
                  </div>
                  <div class="progress-stat">
                    <div class="progress-stat-value" id="stat-votos">0</div>
                    <div class="progress-stat-label">Votos registrados</div>
                  </div>
                  <div class="progress-stat">
                    <div class="progress-stat-value" id="stat-estrelas-m">0/5</div>
                    <div class="progress-stat-label">Estrelas Manh√£</div>
                  </div>
                  <div class="progress-stat">
                    <div class="progress-stat-value" id="stat-estrelas-t">0/5</div>
                    <div class="progress-stat-label">Estrelas Tarde</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <div class="card-title">Turmas e apresentadores</div>
              </div>
              <div class="card-subtitle">
                Escolha a turma e depois clique no nome da pessoa que est√° apresentando para registrar suas notas.
              </div>

              <div id="turmas-buttons" class="pill-list"></div>
              <div style="margin-top:12px;">
                <div class="small-title">Apresentadores da turma selecionada</div>
                <div id="apresentadores-pills" class="pill-list" style="margin-top:6px;"></div>
                <div id="turmas-status" class="status"></div>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <div class="card-title" id="selected-presenter-title">Selecione um apresentador</div>
              </div>
              <div id="perguntas-container" style="margin-top:4px;"></div>

              <!-- linha com bot√£o Pr√≥ximo -->
              <div style="margin-top:14px; display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
                <span class="muted">Quando finalizar as notas deste apresentador, avance para o pr√≥ximo da turma.</span>
                <button class="btn btn-secondary btn-small" id="btn-next-presenter">
                  Pr√≥ximo apresentador &rarr;
                </button>
              </div>

              <div style="margin-top:18px;">
                <div class="section-title">Vota√ß√£o de estrelas da turma</div>
                <div class="muted" id="stars-summary" style="margin-bottom:8px;">
                  Voc√™ ter√° 5 estrelas por per√≠odo para votar nos t√≥picos mais importantes.
                </div>
                <button class="btn btn-secondary btn-small" id="btn-load-stars">
                  Ver / usar minhas estrelas
                </button>
                <div id="stars-status" class="status"></div>
              </div>
            </div>
          </div>

          <!-- ADMIN: Aba Config -->
          <div id="admin-config-area" style="display:none;">
            <div class="card">
              <div class="card-header">
                <div class="card-title">Painel do Admin</div>
                <div class="tabs">
                  <button class="tab active" id="tab-config">Conte√∫do</button>
                  <button class="tab" id="tab-reports">Relat√≥rios</button>
                </div>
              </div>
              <div class="card-subtitle">
                Gerencie perguntas, t√≥picos e acompanhe o desempenho dos pitches.
              </div>
            </div>

            <div id="admin-config-content">
              <div class="card">
                <div class="card-header">
                  <div class="card-title">Sele√ß√£o de Turma e Apresentador</div>
                </div>
                <div class="card-subtitle">
                  Escolha um apresentador para editar suas perguntas e t√≥picos.
                </div>

                <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;">
                  <div>
                    <div class="small-title">Turma</div>
                    <select class="select" id="admin-select-turma"></select>
                  </div>
                  <div>
                    <div class="small-title">Apresentador</div>
                    <select class="select" id="admin-select-apresentador"></select>
                  </div>
                  <div style="margin-top:16px;">
                    <button class="btn btn-secondary btn-small" id="btn-admin-load-conteudo">
                      Carregar perguntas & t√≥picos
                    </button>
                  </div>
                </div>

                <div id="admin-select-status" class="status"></div>
              </div>

              <div class="card">
                <div class="card-header">
                  <div class="card-title">Editar perguntas (opcional)</div>
                </div>
                <div class="card-subtitle">
                  1 pergunta por linha (m√°x. 3). Substitui as perguntas atuais e recria os t√≥picos fict√≠cios.
                </div>
                <textarea id="admin-perguntas-textarea" placeholder="Pergunta 1&#10;Pergunta 2&#10;Pergunta 3"></textarea>
                <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
                  <div class="muted">Ex.: Clareza do problema, Inova√ß√£o da solu√ß√£o, Potencial de mercado.</div>
                  <button class="btn btn-primary btn-small" id="btn-admin-salvar-perguntas">
                    Salvar perguntas
                  </button>
                </div>
                <div id="admin-perguntas-status" class="status"></div>
              </div>

              <div class="card">
                <div class="card-header">
                  <div class="card-title">T√≥picos deste apresentador</div>
                </div>
                <div class="card-subtitle">
                  Edite ou remova t√≥picos existentes e acrescente novos, por pergunta.
                </div>
                <div id="admin-topicos-container"></div>
                <div id="admin-topicos-status" class="status"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Bloco de relat√≥rios admin (fica abaixo, mesma coluna) -->
        <div id="admin-reports-area" style="display:none;">
          <div class="card">
            <div class="card-header">
              <div class="card-title">Relat√≥rios por turma</div>
            </div>
            <div class="card-subtitle">
              Veja rankings por notas e estrelas, e os votos detalhados por participante.
            </div>

            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
              <div>
                <div class="small-title">Turma</div>
                <select class="select" id="admin-relatorio-turma"></select>
              </div>
              <button class="btn btn-secondary btn-small" id="btn-gerar-relatorio">
                Gerar relat√≥rio da turma
              </button>
              <button class="btn btn-primary btn-small" id="btn-export-json">
                Exportar JSON completo
              </button>
              <button class="btn btn-secondary btn-small" id="btn-export-excel">
                Exportar Excel completo
              </button>
            </div>
            <div id="admin-relatorio-status" class="status"></div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">Ranking por m√©dia de notas</div>
            </div>
            <div class="ranking-list" id="ranking-notas"></div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">Ranking por estrelas</div>
            </div>
            <div class="ranking-list" id="ranking-estrelas"></div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">Votos detalhados da turma</div>
            </div>
            <div class="votes-detail-list" id="votos-detalhados"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast de notifica√ß√£o -->
  <div id="toast" class="toast">
    <span id="toast-icon">‚úì</span>
    <span id="toast-message">Mensagem</span>
  </div>

  <!-- Canvas para confetti -->
  <canvas id="confetti-canvas"></canvas>

  <script>
    let currentUser = null;
    let turmasCache = [];
    let apresentadoresCache = [];
    let turmaSelecionada = null;
    let apresentadorSelecionado = null;
    let hasUnsavedChanges = false; // Para confirma√ß√£o de sa√≠da
    let progressData = { votosCount: 0, apresentadoresVotados: new Set(), totalApresentadores: 0 };

    // ==================== TOAST ====================
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toast-message');
      const toastIcon = document.getElementById('toast-icon');
      
      toastMessage.textContent = message;
      toastIcon.textContent = type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚Ñπ';
      
      toast.className = 'toast ' + type;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // ==================== CONFETTI ====================
    function launchConfetti() {
      const canvas = document.getElementById('confetti-canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      
      const confetti = [];
      const colors = ['#16a34a', '#22c55e', '#4ade80', '#86efac', '#fbbf24', '#f59e0b'];
      
      for (let i = 0; i < 150; i++) {
        confetti.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height - canvas.height,
          w: Math.random() * 10 + 5,
          h: Math.random() * 6 + 4,
          color: colors[Math.floor(Math.random() * colors.length)],
          speed: Math.random() * 3 + 2,
          angle: Math.random() * 360,
          spin: Math.random() * 10 - 5
        });
      }
      
      let animationId;
      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        let activeConfetti = 0;
        
        confetti.forEach(c => {
          if (c.y < canvas.height + 50) {
            activeConfetti++;
            c.y += c.speed;
            c.x += Math.sin(c.angle * Math.PI / 180) * 0.5;
            c.angle += c.spin;
            
            ctx.save();
            ctx.translate(c.x, c.y);
            ctx.rotate(c.angle * Math.PI / 180);
            ctx.fillStyle = c.color;
            ctx.fillRect(-c.w / 2, -c.h / 2, c.w, c.h);
            ctx.restore();
          }
        });
        
        if (activeConfetti > 0) {
          animationId = requestAnimationFrame(animate);
        } else {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
      }
      
      animate();
      
      // Parar ap√≥s 4 segundos
      setTimeout(() => {
        cancelAnimationFrame(animationId);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }, 4000);
    }

    // ==================== PROGRESSO ====================
    async function atualizarProgresso() {
      if (!currentUser || currentUser.role === 'admin') return;
      
      try {
        const progressResponse = await api(`/api/usuario/${currentUser.code}/progresso`);
        
        const { votosCount, apresentadoresVotados, totalApresentadores, estrelasManha, estrelasTarde, isLeader, turmasUsuario } = progressResponse;
        
        // Atualizar estat√≠sticas
        setText('stat-votos', votosCount);
        setText('stat-apresentadores', `${apresentadoresVotados}/${totalApresentadores}`);
        
        // Mostrar/esconder estrelas conforme a turma do usu√°rio
        const statEstrelasM = document.getElementById('stat-estrelas-m').parentElement;
        const statEstrelasT = document.getElementById('stat-estrelas-t').parentElement;
        
        if (isLeader) {
          // L√≠deres veem ambas as turmas
          statEstrelasM.style.display = '';
          statEstrelasT.style.display = '';
          setText('stat-estrelas-m', `${estrelasManha}/5`);
          setText('stat-estrelas-t', `${estrelasTarde}/5`);
        } else if (turmasUsuario.includes('M')) {
          // Usu√°rio da manh√£
          statEstrelasM.style.display = '';
          statEstrelasT.style.display = 'none';
          setText('stat-estrelas-m', `${estrelasManha}/5`);
          // Mudar label para "Estrelas" apenas
          statEstrelasM.querySelector('.progress-stat-label').textContent = 'Estrelas';
        } else if (turmasUsuario.includes('T')) {
          // Usu√°rio da tarde
          statEstrelasM.style.display = 'none';
          statEstrelasT.style.display = '';
          setText('stat-estrelas-t', `${estrelasTarde}/5`);
          // Mudar label para "Estrelas" apenas
          statEstrelasT.querySelector('.progress-stat-label').textContent = 'Estrelas';
        } else {
          // Sem turma definida - esconder ambas
          statEstrelasM.style.display = 'none';
          statEstrelasT.style.display = 'none';
        }
        
        // Atualizar barra de progresso (baseada em apresentadores votados)
        const percentage = totalApresentadores > 0 ? (apresentadoresVotados / totalApresentadores) * 100 : 0;
        document.getElementById('progress-bar').style.width = `${percentage}%`;
        
        // Salvar para uso posterior
        progressData = { votosCount, apresentadoresVotados, totalApresentadores };
        
        // Celebrar quando completar 100%
        if (apresentadoresVotados === totalApresentadores && totalApresentadores > 0) {
          // S√≥ celebra uma vez
          if (!sessionStorage.getItem('celebrated_100')) {
            sessionStorage.setItem('celebrated_100', 'true');
            showToast('üéâ Parab√©ns! Voc√™ votou em todos os apresentadores!', 'success');
            launchConfetti();
          }
        }
      } catch (err) {
        console.error('Erro ao carregar progresso:', err);
      }
    }

    // ==================== CONFIRMA√á√ÉO DE SA√çDA ====================
    window.addEventListener('beforeunload', (e) => {
      if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = 'Voc√™ tem altera√ß√µes n√£o salvas. Deseja realmente sair?';
        return e.returnValue;
      }
    });

    function setText(id, text) {
      const el = document.getElementById(id);
      if (el) el.textContent = text;
    }

    function setHtml(id, html) {
      const el = document.getElementById(id);
      if (el) el.innerHTML = html;
    }

    function show(id) {
      const el = document.getElementById(id);
      if (el) el.style.display = "";
    }

    function hide(id) {
      const el = document.getElementById(id);
      if (el) el.style.display = "none";
    }

    async function api(path, options = {}) {
      const resp = await fetch(path, {
        headers: { "Content-Type": "application/json" },
        ...options
      });
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok || data.ok === false) {
        const message = (data && data.message) || `Erro HTTP ${resp.status}`;
        throw new Error(message);
      }
      return data;
    }

    // LOGIN
    document.getElementById("btn-login").addEventListener("click", async () => {
      const code = document.getElementById("input-code").value.trim();
      const statusEl = document.getElementById("login-status");
      statusEl.textContent = "";
      statusEl.className = "status";

      if (!code) {
        statusEl.textContent = "Informe o c√≥digo.";
        statusEl.classList.add("status-error");
        return;
      }

      try {
        const dataResp = await api("/login", {
          method: "POST",
          body: JSON.stringify({ code })
        });

        currentUser = dataResp.user;

        setText("welcome-title", `Bem-vindo, ${currentUser.name}!`);

        if (currentUser.role === "admin") {
          setText("welcome-subtitle", "Voc√™ est√° no Painel do Admin da vota√ß√£o de pitches.");
          const badge = document.getElementById("role-badge");
          badge.textContent = "Admin";
          badge.className = "badge badge-admin";

          hide("participant-area");
          show("admin-config-area");
          show("admin-reports-area");
          show("main-layout");

          carregarAdminSelects();
        } else {
          setText("welcome-subtitle", "Escolha a turma e o apresentador em apresenta√ß√£o para registrar suas notas.");
          const badge = document.getElementById("role-badge");
          badge.textContent = "Participante";
          badge.className = "badge badge-participant";

          show("participant-area");
          hide("admin-config-area");
          hide("admin-reports-area");
          show("main-layout");

          carregarTurmas();
          atualizarProgresso(); // Carregar progresso inicial
        }

        hide("card-login");
      } catch (err) {
        statusEl.textContent = err.message;
        statusEl.classList.add("status-error");
      }
    });

    // PARTICIPANTE ‚Äì Turmas / Apresentadores
    async function carregarTurmas() {
      const statusEl = document.getElementById("turmas-status");
      statusEl.textContent = "";
      statusEl.className = "status";

      try {
        const dados = await api("/api/turmas-com-apresentadores");
        turmasCache = dados.turmas;

        const turmasButtonsEl = document.getElementById("turmas-buttons");
        turmasButtonsEl.innerHTML = "";

        turmasCache.forEach(t => {
          const btn = document.createElement("button");
          btn.className = "btn btn-outline btn-pill";
          btn.textContent = t.name;
          btn.addEventListener("click", () => {
            turmaSelecionada = t.id;
            atualizarBotaoTurmaSelecionada();
            listarApresentadores(t);
            setText("selected-presenter-title", "Selecione um apresentador para ver as perguntas.");
            document.getElementById("perguntas-container").innerHTML = "";
            document.getElementById("stars-status").textContent = "";
            document.getElementById("stars-summary").textContent =
              "Voc√™ ter√° 5 estrelas por per√≠odo para votar nos t√≥picos mais importantes.";
          });
          btn.dataset.turmaId = t.id;
          turmasButtonsEl.appendChild(btn);
        });

        if (turmasCache.length > 0) {
          turmaSelecionada = turmasCache[0].id;
          atualizarBotaoTurmaSelecionada();
          listarApresentadores(turmasCache[0]);
        }

      } catch (err) {
        statusEl.textContent = err.message;
        statusEl.classList.add("status-error");
      }
    }

    function atualizarBotaoTurmaSelecionada() {
      const buttons = document.querySelectorAll("#turmas-buttons .btn-outline");
      buttons.forEach(btn => {
        if (btn.dataset.turmaId === String(turmaSelecionada)) {
          btn.classList.add("active");
        } else {
          btn.classList.remove("active");
        }
      });
    }

    function listarApresentadores(turma) {
      const pillsEl = document.getElementById("apresentadores-pills");
      pillsEl.innerHTML = "";

      if (!turma.apresentadores || turma.apresentadores.length === 0) {
        pillsEl.innerHTML = '<span class="muted">N√£o h√° apresentadores nesta turma.</span>';
        return;
      }

      turma.apresentadores.forEach(ap => {
        const btn = document.createElement("button");
        btn.className = "btn btn-secondary btn-small btn-pill";
        btn.textContent = ap.name;
        btn.dataset.code = ap.code;
        btn.addEventListener("click", () => {
          apresentadorSelecionado = ap.code;
          marcarApresentadorSelecionado();
          carregarPerguntas(ap.code);
        });
        pillsEl.appendChild(btn);
      });
    }

    function marcarApresentadorSelecionado() {
      const pills = document.querySelectorAll("#apresentadores-pills .btn-pill");
      pills.forEach(p => {
        if (p.dataset.code === String(apresentadorSelecionado)) {
          p.classList.add("active");
          p.style.background = "#111827";
          p.style.color = "#f9fafb";
        } else {
          p.classList.remove("active");
          p.style.background = "#f9fafb";
          p.style.color = "#111827";
        }
      });
    }

    async function carregarPerguntas(apresentadorCode) {
      const container = document.getElementById("perguntas-container");
      container.innerHTML = "";
      const titleEl = document.getElementById("selected-presenter-title");
      titleEl.textContent = "Carregando perguntas...";

      try {
        // Buscar perguntas E votos existentes do usu√°rio em paralelo
        const [dados, votosData] = await Promise.all([
          api(`/api/apresentador/${apresentadorCode}/perguntas`),
          currentUser ? api(`/api/votos/usuario/${currentUser.code}/apresentador/${apresentadorCode}`) : { votos: [] }
        ]);

        // Criar mapa de votos existentes: topicoId -> nota
        const votosExistentes = {};
        (votosData.votos || []).forEach(v => {
          votosExistentes[v.topicoId] = v.nota;
        });

        titleEl.textContent = `${dados.apresentador.name}`;

        if (!dados.perguntas || dados.perguntas.length === 0) {
          container.innerHTML = '<div class="muted">Nenhuma pergunta cadastrada para este apresentador.</div>';
          return;
        }

        const fragment = document.createDocumentFragment();

        dados.perguntas.forEach(perg => {
          const perguntaDiv = document.createElement("div");
          perguntaDiv.style.marginBottom = "14px";

          const pTitle = document.createElement("div");
          pTitle.className = "question-title";
          pTitle.textContent = perg.texto;
          perguntaDiv.appendChild(pTitle);

          perg.topicos.forEach(top => {
            const topicDiv = document.createElement("div");
            topicDiv.className = "topic-block";

            const topicText = document.createElement("div");
            topicText.className = "topic-text";
            topicText.textContent = top.texto;
            topicDiv.appendChild(topicText);

            const instr = document.createElement("div");
            instr.className = "topic-instruction";

            // l√≠deres (1‚Äì6) votam de 1 a 10, demais de 1 a 5
            const leadersCodes = ["1", "2", "3", "4", "5", "6"];
            const isLeaderUser = currentUser && leadersCodes.includes(String(currentUser.code));
            const maxNota = isLeaderUser ? 10 : 5;

            instr.textContent = isLeaderUser
              ? "D√™ uma nota de 1 a 10 para este t√≥pico:"
              : "D√™ uma nota de 1 a 5 para este t√≥pico:";
            topicDiv.appendChild(instr);

            const votesRow = document.createElement("div");
            votesRow.className = "votes-row";

            // Verificar se j√° existe voto para este t√≥pico
            const votoExistente = votosExistentes[top.id];

            for (let note = 1; note <= maxNota; note++) {
              const voteBtn = document.createElement("button");
              voteBtn.className = "vote-pill";
              voteBtn.textContent = note;
              voteBtn.dataset.topicoId = top.id;
              voteBtn.dataset.note = note;

              // Se j√° votou neste t√≥pico, marcar o bot√£o correspondente
              if (votoExistente !== undefined && Number(votoExistente) === note) {
                voteBtn.classList.add("selected");
              }

              voteBtn.addEventListener("click", () => votarTopico(top.id, note, votesRow));
              votesRow.appendChild(voteBtn);
            }

            topicDiv.appendChild(votesRow);
            perguntaDiv.appendChild(topicDiv);
          });

          fragment.appendChild(perguntaDiv);
        });

        container.appendChild(fragment);

      } catch (err) {
        titleEl.textContent = "Erro ao carregar perguntas";
        container.innerHTML = `<div class="status status-error">${err.message}</div>`;
      }
    }

    async function votarTopico(topicoId, nota, votesRow) {
      if (!currentUser) return;

      const buttons = votesRow.querySelectorAll(".vote-pill");
      buttons.forEach(b => b.classList.add("disabled"));

      try {
        await api("/api/votos", {
          method: "POST",
          body: JSON.stringify({
            userCode: currentUser.code,
            topicoId,
            nota
          })
        });

        buttons.forEach(b => {
          b.classList.remove("disabled");
          if (Number(b.dataset.note) === Number(nota)) {
            b.classList.add("selected");
            // Anima√ß√£o de pulse
            b.classList.add("just-voted");
            setTimeout(() => b.classList.remove("just-voted"), 300);
          } else {
            b.classList.remove("selected");
          }
        });

        // Mostrar toast de sucesso
        showToast(`Nota ${nota} registrada!`, 'success');
        
        // Atualizar progresso
        atualizarProgresso();
        
      } catch (err) {
        buttons.forEach(b => b.classList.remove("disabled"));
        showToast("Erro ao registrar voto: " + err.message, 'error');
      }
    }

    // Bot√£o "Pr√≥ximo apresentador"
    document.getElementById("btn-next-presenter").addEventListener("click", () => {
      if (!turmaSelecionada || !turmasCache.length) return;
      const turma = turmasCache.find(t => t.id === String(turmaSelecionada));
      if (!turma || !turma.apresentadores || turma.apresentadores.length === 0) return;

      if (!apresentadorSelecionado) {
        apresentadorSelecionado = turma.apresentadores[0].code;
        marcarApresentadorSelecionado();
        carregarPerguntas(apresentadorSelecionado);
        return;
      }

      const idx = turma.apresentadores.findIndex(ap => ap.code === String(apresentadorSelecionado));
      const proxIdx = (idx + 1) % turma.apresentadores.length;
      apresentadorSelecionado = turma.apresentadores[proxIdx].code;
      marcarApresentadorSelecionado();
      carregarPerguntas(apresentadorSelecionado);
    });

    // Estrelas ‚Äì leva para outra p√°gina
    document.getElementById("btn-load-stars").addEventListener("click", () => {
      if (!turmaSelecionada) {
        alert("Selecione uma turma primeiro.");
        return;
      }
      if (!currentUser) return;
      const url = `/estrelas.html?userCode=${encodeURIComponent(currentUser.code)}&turmaId=${encodeURIComponent(turmaSelecionada)}`;
      window.location.href = url;
    });

    // ADMIN ‚Äì TABS
    const tabConfig = document.getElementById("tab-config");
    const tabReports = document.getElementById("tab-reports");
    const adminConfigContent = document.getElementById("admin-config-content");
    const adminReportsArea = document.getElementById("admin-reports-area");

    tabConfig.addEventListener("click", () => {
      tabConfig.classList.add("active");
      tabReports.classList.remove("active");
      adminConfigContent.style.display = "";
      adminReportsArea.style.display = "none";
    });

    tabReports.addEventListener("click", () => {
      tabReports.classList.add("active");
      tabConfig.classList.remove("active");
      adminConfigContent.style.display = "none";
      adminReportsArea.style.display = "";
    });

    // ADMIN ‚Äì Carregar selects
    async function carregarAdminSelects() {
      try {
        const dados = await api("/api/admin/apresentadores");
        apresentadoresCache = dados.apresentadores;
        turmasCache = dados.turmas;

        const selectTurma = document.getElementById("admin-select-turma");
        const selectAp = document.getElementById("admin-select-apresentador");
        const relTurma = document.getElementById("admin-relatorio-turma");

        selectTurma.innerHTML = "";
        relTurma.innerHTML = "";

        turmasCache.forEach(t => {
          const opt = document.createElement("option");
          opt.value = t.id;
          opt.textContent = t.name;
          selectTurma.appendChild(opt);

          const opt2 = document.createElement("option");
          opt2.value = t.id;
          opt2.textContent = t.name;
          relTurma.appendChild(opt2);
        });

        atualizarSelectApresentadores();

      } catch (err) {
        const statusEl = document.getElementById("admin-select-status");
        statusEl.textContent = "Erro ao carregar listas: " + err.message;
        statusEl.classList.add("status-error");
      }
    }

    function atualizarSelectApresentadores() {
      const selectTurma = document.getElementById("admin-select-turma");
      const selectAp = document.getElementById("admin-select-apresentador");
      const turmaId = selectTurma.value;

      selectAp.innerHTML = "";
      const filtrados = apresentadoresCache.filter(ap => ap.turmaId === turmaId && ap.isPresenter);
      filtrados.forEach(ap => {
        const opt = document.createElement("option");
        opt.value = ap.code;
        opt.textContent = `${ap.name} (${ap.code})`;
        selectAp.appendChild(opt);
      });

      if (filtrados.length === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Sem apresentadores nesta turma";
        selectAp.appendChild(opt);
      }
    }

    document.getElementById("admin-select-turma").addEventListener("change", atualizarSelectApresentadores);

    document.getElementById("btn-admin-load-conteudo").addEventListener("click", async () => {
      const selectAp = document.getElementById("admin-select-apresentador");
      const code = selectAp.value;
      const statusEl = document.getElementById("admin-select-status");
      statusEl.textContent = "";
      statusEl.className = "status";

      if (!code) {
        statusEl.textContent = "Selecione um apresentador v√°lido.";
        statusEl.classList.add("status-error");
        return;
      }

      try {
        const dados = await api(`/api/admin/conteudo?code=${encodeURIComponent(code)}`);
        preencherAdminConteudo(dados);
        statusEl.textContent = "Conte√∫do carregado.";
        statusEl.classList.add("status-success");
      } catch (err) {
        statusEl.textContent = err.message;
        statusEl.classList.add("status-error");
      }
    });

    function preencherAdminConteudo(dados) {
      const textarea = document.getElementById("admin-perguntas-textarea");
      const topicosCont = document.getElementById("admin-topicos-container");

      const perguntas = dados.perguntas || [];
      textarea.value = perguntas.map(p => p.texto).join("\n");

      topicosCont.innerHTML = "";

      if (perguntas.length === 0) {
        topicosCont.innerHTML = '<div class="muted">Nenhuma pergunta cadastrada para este apresentador.</div>';
        return;
      }

      perguntas.forEach(p => {
        const wrap = document.createElement("div");
        wrap.style.marginBottom = "16px";

        const title = document.createElement("div");
        title.className = "question-title";
        title.textContent = p.texto;
        wrap.appendChild(title);

        if (!p.topicos || p.topicos.length === 0) {
          const mt = document.createElement("div");
          mt.className = "muted";
          mt.textContent = "Sem t√≥picos cadastrados.";
          wrap.appendChild(mt);
        } else {
          p.topicos.forEach(top => {
            const row = document.createElement("div");
            row.className = "topic-admin-row";

            const input = document.createElement("input");
            input.type = "text";
            input.className = "input";
            input.value = top.texto;

            const btnSave = document.createElement("button");
            btnSave.className = "btn btn-secondary btn-small btn-icon";
            btnSave.textContent = "Salvar";

            const btnDel = document.createElement("button");
            btnDel.className = "btn btn-danger btn-small btn-icon";
            btnDel.textContent = "Apagar";

            btnSave.addEventListener("click", async () => {
              const texto = input.value.trim();
              if (!texto) {
                alert("Texto do t√≥pico n√£o pode ser vazio.");
                return;
              }
              try {
                const resp = await api(`/api/admin/topicos/${top.id}`, {
                  method: "PUT",
                  body: JSON.stringify({ texto })
                });
                document.getElementById("admin-topicos-status").textContent = resp.message;
                document.getElementById("admin-topicos-status").className = "status status-success";
              } catch (err) {
                document.getElementById("admin-topicos-status").textContent = err.message;
                document.getElementById("admin-topicos-status").className = "status status-error";
              }
            });

            btnDel.addEventListener("click", async () => {
              if (!confirm("Tem certeza que deseja apagar este t√≥pico?")) return;
              try {
                const resp = await api(`/api/admin/topicos/${top.id}`, {
                  method: "DELETE"
                });
                document.getElementById("admin-topicos-status").textContent = resp.message;
                document.getElementById("admin-topicos-status").className = "status status-success";

                const selectAp = document.getElementById("admin-select-apresentador");
                const code = selectAp.value;
                const dadosNovos = await api(`/api/admin/conteudo?code=${encodeURIComponent(code)}`);
                preencherAdminConteudo(dadosNovos);
              } catch (err) {
                document.getElementById("admin-topicos-status").textContent = err.message;
                document.getElementById("admin-topicos-status").className = "status status-error";
              }
            });

            row.appendChild(input);
            row.appendChild(btnSave);
            row.appendChild(btnDel);
            wrap.appendChild(row);
          });
        }

        const novoWrap = document.createElement("div");
        novoWrap.style.marginTop = "8px";
        const inputNovo = document.createElement("input");
        inputNovo.type = "text";
        inputNovo.className = "input";
        inputNovo.placeholder = "Novo t√≥pico desta pergunta‚Ä¶";

        const btnAdd = document.createElement("button");
        btnAdd.className = "btn btn-secondary btn-small";
        btnAdd.textContent = "Adicionar t√≥pico";
        btnAdd.style.marginTop = "6px";

        btnAdd.addEventListener("click", async () => {
          const texto = inputNovo.value.trim();
          if (!texto) {
            alert("Digite o texto do novo t√≥pico.");
            return;
          }
          try {
            const resp = await api("/api/admin/topicos", {
              method: "POST",
              body: JSON.stringify({ perguntaId: p.id, texto })
            });
            inputNovo.value = "";
            document.getElementById("admin-topicos-status").textContent = resp.message;
            document.getElementById("admin-topicos-status").className = "status status-success";
            const selectAp = document.getElementById("admin-select-apresentador");
            const code = selectAp.value;
            const dadosNovos = await api(`/api/admin/conteudo?code=${encodeURIComponent(code)}`);
            preencherAdminConteudo(dadosNovos);
          } catch (err) {
            document.getElementById("admin-topicos-status").textContent = err.message;
            document.getElementById("admin-topicos-status").className = "status status-error";
          }
        });

        novoWrap.appendChild(inputNovo);
        novoWrap.appendChild(btnAdd);
        wrap.appendChild(novoWrap);

        topicosCont.appendChild(wrap);
      });
    }

    document.getElementById("btn-admin-salvar-perguntas").addEventListener("click", async () => {
      const selectAp = document.getElementById("admin-select-apresentador");
      const code = selectAp.value;
      const textarea = document.getElementById("admin-perguntas-textarea");
      const statusEl = document.getElementById("admin-perguntas-status");

      statusEl.textContent = "";
      statusEl.className = "status";

      if (!code) {
        statusEl.textContent = "Selecione um apresentador.";
        statusEl.classList.add("status-error");
        return;
      }

      try {
        const resp = await api("/api/admin/perguntas", {
          method: "POST",
          body: JSON.stringify({
            apresentadorCode: code,
            perguntasText: textarea.value
          })
        });
        statusEl.textContent = resp.message;
        statusEl.classList.add("status-success");

        const dadosNovos = await api(`/api/admin/conteudo?code=${encodeURIComponent(code)}`);
        preencherAdminConteudo(dadosNovos);

      } catch (err) {
        statusEl.textContent = err.message;
        statusEl.classList.add("status-error");
      }
    });

    // Relat√≥rios
    document.getElementById("btn-gerar-relatorio").addEventListener("click", async () => {
      const sel = document.getElementById("admin-relatorio-turma");
      const turmaId = sel.value;
      const statusEl = document.getElementById("admin-relatorio-status");
      statusEl.textContent = "";
      statusEl.className = "status";

      if (!turmaId) {
        statusEl.textContent = "Selecione uma turma.";
        statusEl.classList.add("status-error");
        return;
      }

      try {
        const dados = await api(`/api/admin/relatorio?turmaId=${encodeURIComponent(turmaId)}`);
        statusEl.textContent = `Relat√≥rio gerado para ${dados.turma.name}.`;
        statusEl.classList.add("status-success");
        preencherRanking(dados);
        preencherVotosDetalhados(dados);
      } catch (err) {
        statusEl.textContent = err.message;
        statusEl.classList.add("status-error");
      }
    });

    function preencherRanking(dados) {
      const rankingNotasEl = document.getElementById("ranking-notas");
      const rankingEstrelasEl = document.getElementById("ranking-estrelas");

      const rn = dados.rankingNotas || [];
      const re = dados.rankingEstrelas || [];

      rankingNotasEl.innerHTML = "";
      rankingEstrelasEl.innerHTML = "";

      if (rn.length === 0) {
        rankingNotasEl.innerHTML = '<div class="muted">Ainda n√£o h√° votos registrados.</div>';
      } else {
        rn.forEach((item, idx) => {
          const div = document.createElement("div");
          div.className = "ranking-item";
          div.innerHTML = `
            <div class="ranking-title">${idx + 1}. ${item.texto}</div>
            <div class="ranking-meta">
              <span>Apresentador: ${item.apresentadorNome}</span>
              <span class="chip">M√©dia: ${item.media.toFixed(2)}</span>
              <span class="chip">Votos: ${item.qtdVotos}</span>
            </div>
          `;
          rankingNotasEl.appendChild(div);
        });
      }

      if (re.length === 0) {
        rankingEstrelasEl.innerHTML = '<div class="muted">Ainda n√£o h√° estrelas registradas.</div>';
      } else {
        re.forEach((item, idx) => {
          const div = document.createElement("div");
          div.className = "ranking-item";
          div.innerHTML = `
            <div class="ranking-title">${idx + 1}. ${item.texto}</div>
            <div class="ranking-meta">
              <span>Apresentador: ${item.apresentadorNome}</span>
              <span class="chip">Estrelas: ${item.totalEstrelas}</span>
              <span class="chip">M√©dia: ${item.media.toFixed(2)}</span>
            </div>
          `;
          rankingEstrelasEl.appendChild(div);
        });
      }
    }

    function preencherVotosDetalhados(dados) {
      const container = document.getElementById("votos-detalhados");
      container.innerHTML = "";
      const rn = dados.rankingNotas || [];
      if (rn.length === 0) {
        container.innerHTML = '<div class="muted">Ainda n√£o h√° votos registrados.</div>';
        return;
      }

      rn.forEach(item => {
        if (!item.votosDetalhados || item.votosDetalhados.length === 0) return;
        const div = document.createElement("div");
        div.className = "vote-detail-item";
        const lista = item.votosDetalhados.map(v => {
          return `${v.userName} (${v.userCode}) ‚Üí nota ${v.nota}`;
        }).join(" ¬∑ ");

        div.innerHTML = `
          <div class="vote-detail-title">${item.texto}</div>
          <div class="vote-detail-meta">${lista}</div>
        `;
        container.appendChild(div);
      });

      if (!container.innerHTML) {
        container.innerHTML = '<div class="muted">Ainda n√£o h√° votos registrados.</div>';
      }
    }

    // Export JSON
    document.getElementById("btn-export-json").addEventListener("click", async () => {
      try {
        const resp = await fetch("/api/admin/export-json");
        if (!resp.ok) throw new Error("Erro ao exportar JSON.");
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "dados-votacao.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (err) {
        const statusEl = document.getElementById("admin-relatorio-status");
        statusEl.textContent = err.message;
        statusEl.className = "status status-error";
      }
    });

    // Export Excel completo
    document.getElementById("btn-export-excel").addEventListener("click", async () => {
      try {
        const resp = await fetch("/api/admin/export-excel-completo");
        if (!resp.ok) throw new Error("Erro ao exportar Excel.");
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "relatorio-votacao-completo.xlsx";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (err) {
        const statusEl = document.getElementById("admin-relatorio-status");
        statusEl.textContent = err.message;
        statusEl.className = "status status-error";
      }
    });
  </script>
</body>
</html>
